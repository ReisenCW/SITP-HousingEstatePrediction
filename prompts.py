# prompts.py
PROMPTS = {
    # 解析问题（区域和时间范围）
    "parse_query": """
    请从问题中提取房价预测的区域和时间范围，输出格式：
    区域：[具体区域]
    时间范围：[预测的时间段]
    例子：
    问题：2024年上半年黄浦董家渡房价走势如何
    区域：[黄浦区董家渡]
    时间范围：[2024年1月-6月]
    问题：{query}
    """,

    # 搜索相关信息
    "search_related_info": """
    请联网搜索与{region}房价相关且发生在{time_range}及其之前6个月内的相关消息(一定不能晚于{time_range}),新闻或政策，总结为利好和利空因素，注意时间越久远，相关性越低，因此时间距离较大时只需要考虑那些影响房价较大的因素。
    每条消息简明扼要，注明时间，来源和标题，用一句话说明，只输出消息列表，不要解释。
    """,

    # 预测房价趋势（带动态内容拼接逻辑）
    "predict_trend": """
    综合权衡以下提供的所有利好与利空信息，客观预测{region}在{time_range}的房价趋势及幅度。
    幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
    信息：{info}
    同时根据历史的反思记录和COT轨迹, 吸取成功失败的经验教训, 避免犯同样的错误：
    {reflection_history}
    {recent_cot}

    请严格按下面的结构化模板输出，不要省略任何小节，每一项尽量以数据或明确边界说明，避免模糊表述（如“情绪转暖”）。

    1. 政策分析：[政策名称+时间+适用范围+对目标区域的直接/间接影响，若有量化影响请给出可验证指标]
    2. 区域特性：[供应/需求结构+历史价格波动特征+流动性（近6个月成交量）——用具体数值或区间说明]
    3. 量价关系：[成交量变化（绝对/同比/环比）+成交价/挂牌价趋势+是否存在“以价换量”等特殊情况，用数据锚定]
    4. 时间边界：[信息是否在预测周期内+政策时滞评估（如3个月/6个月），若不在周期内说明延迟生效风险]
    5. 历史反思复用：[如果没有用到反思,回答无。如果引用了过往类似案例的反思结论，说明如何规避同类错误，给出参考案例的量化对比]
    6. 结论（预测结果）：[趋势+幅度，给出置信度/理由，并列出两个对冲情景及触发条件]
    房价预测结果:
    幅度 + 上升/下降/基本持平/先上升后下降等,涨/跌幅约X%左右/X%-Y%/X%以内

    输出示例：
    1. 政策分析：XXX（2024-06，适用于市级→对朝阳区二手限购有直接影响：放松限购，预计新增成交=+10%）
    2. 区域特性：近6月网签量=25500套（同比+30%），历史年化波动=±6%
    3. 量价关系：网签量↑30%，成交均价环比+0.3%，说明以价换量为主
    4. 时间边界：政策于预测周期前1月公布，预计影响滞后1-2月
    5. 历史反思复用：参考2024年X市xxx案例，xxx
    6. 结论（预测结果）：小幅上升，约1%（置信度中等）；对冲情景A: 若网签量持续↑且挂牌价↑则上行幅度可达3%；情景B: 若信贷收紧则可能回落至持平
    房价预测结果:
    - 小幅上升,涨幅约1%左右
    - 基本持平,0.5%以内
    - 先小幅上升,1%左右,后大幅下降,约5%左右
    """,

    # 获取实际趋势
    "get_actual_trend": """
    请联网查询并分析{region}在{time_range}的实际房价均价变化趋势及幅度。幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
    只输出变化趋势和幅度, 输出格式严格按照以下模板, 不添加任何额外内容:
    - 小幅上升,约1%左右
    - 基本持平,0.5%以内
    - 先小幅上升,1%左右,后大幅下降,约5%左右
    """,

    # 成功反思
    "generate_reflection_success": """
    你是房价预测智能体的反思模块。本次预测被评分为{score}分（成功）。{history_reminder}请基于下列信息输出一份结构化且可复用的“成功反思”，重点固化有效逻辑与复用框架：
    问题：{query}
    当前推理轨迹：
    {current_trajectory}
    最近3条思维链（COT）：
    {recent_cot}
    历史反思记录：
    {persistent_memory}
    预测结果：{prediction}
    实际结果：{actual}
    评分：{score}分
    预测时使用的信息：{info}

    输出格式（严格文本模板）：

    反思（成功）：
    1. **关键因素**：
    - 用1-3条短句明确指出预测成功的核心依据，尽量使用数据或可验证的断言。
    - 使用抽象区域类型或特征标签（如“高流动性区域/月均成交>Y套”、“政策敏感型市场”）表述，避免具体区域名称。

    2. **推理逻辑验证**：
    - 列出1-3个主要假设/判断，并说明是否被实际结果验证。
    - 示例："量价关系判断成立 —— 网签量上升但均价环比仅+0.3%，与以价换量判断一致"。

    3. **可复用框架**：
    - 提炼可直接复用到未来预测中的方法（3点以内），使用抽象维度（区域类型/政策类型/市场阶段）表达。
    - 示例："高流动性区域（月均成交>Y套）：优先评估政策时效性与量价同步性，若政策发布距预测期<3个月且成交量环比增长10%+，上调短期涨幅预期"。

    4. **可执行条目**：
    - 给出3条可直接编码或加入数据管线的改进（字段/指标/阈值）。
    - 优先使用通用指标（如“政策影响半径（月）”、“量价弹性系数”）而非区域专有字段。

    5. **示例与量化证据**：
    - 引用本次案例中的明确数据点（时间/量/价）作为示例。
    - 在示例中同时给出抽象化规则描述，便于迁移到其他区域。

    要求：建议应可直接用于未来预测流程和数据接入，且以抽象标签/规则形式给出，便于跨区域复用。
    """,

    # 失败反思
    "generate_reflection_failure": """
    你是房价预测智能体的反思模块。本次预测被评分为{score}分（失败/偏差）。{history_reminder}请基于下列信息输出一份结构化且可复用的“失败反思”，重点固化有效逻辑与复用框架：
    问题：{query}
    当前推理轨迹：
    {current_trajectory}
    最近3条思维链（COT）：
    {recent_cot}
    历史反思记录：
    {persistent_memory}
    预测结果：{prediction}
    实际结果：{actual}
    评分：{score}分
    预测时使用的信息：{info}

    输出格式（严格文本模板）：

   反思（失败）：
    1. **错误分析**：
    - 简要列出1-3处关键错误或漏判，用抽象类型表述（如“趋势判断错误/幅度低估/多阶段错误”）。
    - 示例："趋势判断错误 —— 预测为持平，但实际环比下降3%，未考虑政策滞后效应"。

    2. **失败原因**：
    - 说明导致偏差的核心原因（数据/模型/逻辑/时序），优先以普适性错误类型表述。
    - 示例："未区分政策适用范围与区域类型匹配度，导致政策影响高估"。

    3. **改进策略**：
    - 提出3条可操作改进（具体到字段/阈值/方法），并说明这些改进如何适用于不同区域类型。
    - 示例："增加政策适用范围字段，评估区域匹配度；引入政策滞后效应模型；优化成交量与价格弹性系数的动态调整逻辑"。

    4. **可复用框架**：
    - 提炼可直接复用到未来预测中的方法（3点以内），使用抽象维度（区域类型/政策类型/市场阶段）表达。
    - 示例："政策敏感型市场：优先评估政策适用范围与区域匹配度，若匹配度<50%，下调政策影响权重"。

    5. **示例与量化证据**：
    - 引用本次案例中的明确数据点（时间/量/价）作为示例。
    - 在示例中同时给出抽象化规则描述，便于迁移到其他区域。

    要求：建议应可直接用于未来预测流程和数据接入。
    """,
    
    # LLM评分规则
    "evaluator_parse_trend": """
    请解析以下房价趋势描述，提取阶段信息。每个阶段包含趋势方向和幅度值（百分比）。
    趋势方向包括：上升、下降、持平。
    幅度值需转换为具体数字（如"小幅上升"→1%，"显著下降"→-3%，"0.5%-1.5%"→1.0%，"约2%"→2.0%，"0.5%以内"→0.5%）。
    多阶段用"先...后..."描述时，请拆分为多个阶段。
    输出格式为JSON数组，例如：
    输入："先持平后小幅上升,幅度0.5%-1.5%"
    输出：[{{"trend": "持平", "magnitude": 0.5}}, {{"trend": "上升", "magnitude": 1.0}}]  # 这里用双大括号转义
    
    待解析内容：{content}
    """
}


