# prompts.py
PROMPTS = {
    # 解析问题（区域和时间范围）
    "parse_query": """
    请从问题中提取房价预测的区域和时间范围，输出格式：
    区域：[具体区域]
    时间范围：[预测的时间段]
    例子：
    问题：2024年上半年黄浦董家渡房价走势如何
    区域：[黄浦区董家渡]
    时间范围：[2024年1月-6月]
    问题：{query}
    """,

    # 搜索相关信息
    "search_related_info": """
    请联网搜索与{region}房价相关且发生在{time_range}及其之前6个月内的相关消息(一定不能晚于{time_range}),新闻或政策，总结为利好和利空因素，注意时间越久远，相关性越低，因此时间距离较大时只需要考虑那些影响房价较大的因素。
    每条消息简明扼要，注明时间，来源和标题，用一句话说明，只输出消息列表，不要解释。
    """,

    # 预测房价趋势（带动态内容拼接逻辑）
    "predict_trend": """
    综合权衡以下提供的所有利好与利空信息，客观预测{region}在{time_range}的房价趋势及幅度。
    幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
    信息：{info}
    同时根据历史的反思记录和COT轨迹, 吸取成功失败的经验教训, 避免犯同样的错误：
    {reflection_history}
    {recent_cot}

    请严格按下面的结构化模板输出，不要省略任何小节，每一项尽量以数据或明确边界说明，避免模糊表述（如“情绪转暖”）。

    1. 政策分析：[政策名称+时间+适用范围+对目标区域的直接/间接影响，若有量化影响请给出可验证指标]
    2. 区域特性：[供应/需求结构+历史价格波动特征+流动性（近6个月成交量）——用具体数值或区间说明]
    3. 量价关系：[成交量变化（绝对/同比/环比）+成交价/挂牌价趋势+是否存在“以价换量”等特殊情况，用数据锚定]
    4. 时间边界：[信息是否在预测周期内+政策时滞评估（如3个月/6个月），若不在周期内说明延迟生效风险]
    5. 历史反思复用：[如果没有用到反思,回答无。如果引用了过往类似案例的反思结论，说明如何规避同类错误，给出参考案例的量化对比]
    6. 结论（预测结果）：[趋势+幅度，给出置信度/理由，并列出两个对冲情景及触发条件]
    房价预测结果:
    结果

    输出示例：
    1. 政策分析：XXX（2024-06，适用于市级→对朝阳区二手限购有直接影响：放松限购，预计新增成交=+10%）
    2. 区域特性：近6月网签量=25500套（同比+30%），历史年化波动=±6%
    3. 量价关系：网签量↑30%，成交均价环比+0.3%，说明以价换量为主
    4. 时间边界：政策于预测周期前1月公布，预计影响滞后1-2月
    5. 历史反思复用：参考2024年X市xxx案例，xxx
    6. 结论（预测结果）：小幅上升，约1%（置信度中等）；对冲情景A: 若网签量持续↑且挂牌价↑则上行幅度可达3%；情景B: 若信贷收紧则可能回落至持平
    房价预测结果:
    小幅上升,约1%左右
    """,

    # 获取实际趋势
    "get_actual_trend": """
    请联网查询{region}在{time_range}的实际房价均价趋势及幅度。
    幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
    输出格式例如：
    - 小幅上升,约1%左右
    - 基本持平,0.5%以内
    - 先小幅上升,1%左右,后大幅下降,约5%左右
    不添加任何额外内容
    """,

    # 成功反思
    "generate_reflection_success": """
    你是房价预测智能体的反思模块（reflect_llm）。本次预测被评分为{score}分（成功）。{history_reminder}请基于下列信息输出一份结构化且可复用的“成功反思”，重点固化有效逻辑与复用框架：
    问题：{query}
    当前推理轨迹：
    {current_trajectory}
    最近3条思维链（COT）：
    {recent_cot}
    历史反思记录：
    {persistent_memory}
    预测结果：{prediction}
    实际结果：{actual}
    评分：{score}分
    预测时使用的信息：{info}

    输出要求（严格遵守）：
    反思（成功）：\n
    1. 关键因素：用1-3条短句明确指出这次预测成功的核心依据（尽量使用数据或可验证的断言），例如"准确区分政策适用区域（外环外）与目标区域（黄浦区）"。
    2. 推理逻辑验证：列出1-3个你当时主要的假设/判断并说明是否被实际结果验证，示例："量价关系判断成立 —— 网签量↑但均价环比仅+0.3%，与以价换量判断一致"。
    3. 可复用框架：提炼可直接复用到未来预测中的方法（3点以内），格式为"规则/度量 → 触发条件 → 建议的操作"，例如"核心区预测：优先评估历史波动率与交易频次 → 若季度涨幅均<0.5%且月均成交<X则低弹性 → 下调幅度预期"。
    4. 可执行条目：给出3条可直接编码或加入数据管线的改进（字段/指标/阈值），例如新增字段"历史季度波动率_3Y"并写出阈值说明。
    5. 示例与量化证据：引用本次案例中的明确数据点（时间/量/价）作为示例，便于后续审计与教学。

    输出格式（严格文本模板）：
    反思（成功）：\n1. 关键因素：...\n2. 推理逻辑验证：...\n3. 可复用框架：...\n4. 可执行条目：...\n5. 示例与量化证据：...
    """,

    # 失败反思
    "generate_reflection_failure": """
    你是房价预测智能体的反思模块（reflect_llm）。本次预测被评分为{score}分（失败/偏差）。{history_reminder}请基于下列信息输出一份结构化的反思，重点指出错误、根因并给出可执行改进建议：
    问题：{query}
    当前推理轨迹：
    {current_trajectory}
    最近3条思维链（COT）：
    {recent_cot}
    历史反思记录：
    {persistent_memory}
    预测结果：{prediction}
    实际结果：{actual}
    评分：{score}分
    预测时使用的信息：{info}

    输出格式（严格文本模板）：\n
    反思（失败）：\n1. 错误分析：简要列出1-3处关键错误或漏判\n2. 失败原因：说明导致偏差的核心原因（数据/模型/逻辑/时序）\n3. 改进策略：提出3条可操作改进（具体到字段/阈值/方法）\n
    # prompts.py
    PROMPTS = {
        # 解析问题（区域和时间范围）
        "parse_query": """
        请从问题中提取房价预测的区域和时间范围，输出格式：
        区域：[具体区域，如北京市朝阳区]
        时间范围：[预测的时间段，如2024年下半年]

        问题：{query}
        """,

        # 搜索相关信息
        "search_related_info": """
        请联网搜索与{region}房价相关且发生在{time_range}及其之前6个月内的相关消息,新闻或政策，总结为利好和利空因素，注意时间越久远，相关性越低，因此时间距离较大时只需要考虑那些影响房价较大的因素。
        每条消息简明扼要，注明时间，来源和标题，用一句话说明，只输出消息列表，不要解释。
        """,

        # 预测房价趋势（带动态内容拼接逻辑）
        "predict_trend": """
        综合权衡以下提供的所有利好与利空信息，客观预测{region}在{time_range}的房价趋势及幅度。
        幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
        信息：{info}
        {reflection_history}
        {recent_cot}

        请严格按下面的结构化模板输出，不要省略任何小节，每一项尽量以数据或明确边界说明，避免模糊表述（如“情绪转暖”）。

        房价预测结果
        COT:
        1. 政策分析：[政策名称+时间+适用范围+对目标区域的直接/间接影响，若有量化影响请给出可验证指标]
        2. 区域特性：[供应/需求结构+历史价格波动特征+流动性（近6个月成交量）——用具体数值或区间说明]
        3. 量价关系：[成交量变化（绝对/同比/环比）+成交价/挂牌价趋势+是否存在“以价换量”等特殊情况，用数据锚定]
        4. 时间边界：[信息是否在预测周期内+政策时滞评估（如3个月/6个月），若不在周期内说明延迟生效风险]
        5. 历史反思复用：[如果没有用到反思,回答无。如果引用了过往类似案例的反思结论，说明如何规避同类错误，给出参考案例的量化对比]
        6. 结论（预测结果）：[趋势+幅度，给出置信度/理由，并列出两个对冲情景及触发条件]

        输出示例：
        小幅上升,约1%左右
        COT:
        1. 政策分析：XXX（2024-06，适用于市级→对朝阳区二手限购有直接影响：放松限购，预计新增成交=+10%）
        2. 区域特性：近6月网签量=25500套（同比+30%），历史年化波动=±6%
        3. 量价关系：网签量↑30%，成交均价环比+0.3%，说明以价换量为主
        4. 时间边界：政策于预测周期前1月公布，预计影响滞后1-2月
        5. 历史反思复用：参考2023年X市放松限购案例，新增供应推高成交但价格仅小幅上升
        6. 结论（预测结果）：小幅上升，约1%（置信度中等）；对冲情景A: 若网签量持续↑且挂牌价↑则上行幅度可达3%；情景B: 若信贷收紧则可能回落至持平
        """,

        # 获取实际趋势
        "get_actual_trend": """
        请联网查询{region}在{time_range}的实际房价均价趋势及幅度。
        幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
        输出格式例如：
        - 小幅上升,约1%左右
        - 基本持平,0.5%以内
        - 先小幅上升,1%左右,后大幅下降,约5%左右
        不添加任何额外内容
        """,

        # 成功反思
        "generate_reflection_success": """
        你是房价预测智能体的反思模块（reflect_llm）。本次预测被评分为{score}分（成功）。{history_reminder}请基于下列信息输出一份结构化且可复用的“成功反思”，重点固化有效逻辑与复用框架：
        问题：{query}
        当前推理轨迹：
        {current_trajectory}
        最近3条思维链（COT）：
        {recent_cot}
        历史反思记录：
        {persistent_memory}
        预测结果：{prediction}
        实际结果：{actual}
        评分：{score}分
        预测时使用的信息：{info}

        输出要求（严格遵守）：
        反思（成功）：\n
        1. 关键因素：用1-3条短句明确指出这次预测成功的核心依据（尽量使用数据或可验证的断言），例如"准确区分政策适用区域（外环外）与目标区域（黄浦区）"。
        2. 推理逻辑验证：列出1-3个你当时主要的假设/判断并说明是否被实际结果验证，示例："量价关系判断成立 —— 网签量↑但均价环比仅+0.3%，与以价换量判断一致"。
        3. 可复用框架：提炼可直接复用到未来预测中的方法（3点以内），格式为"规则/度量 → 触发条件 → 建议的操作"，例如"核心区预测：优先评估历史波动率与交易频次 → 若季度涨幅均<0.5%且月均成交<X则低弹性 → 下调幅度预期"。
        4. 可执行条目：给出3条可直接编码或加入数据管线的改进（字段/指标/阈值），例如新增字段"历史季度波动率_3Y"并写出阈值说明。
        5. 示例与量化证据：引用本次案例中的明确数据点（时间/量/价）作为示例，便于后续审计与教学。
        """,

        # 失败反思
        "generate_reflection_failure": """
        你是房价预测智能体的反思模块（reflect_llm）。本次预测被评分为{score}分（失败/偏差）。{history_reminder}请基于下列信息输出一份结构化的反思，重点指出错误、根因并给出可执行改进建议：
        问题：{query}
        当前推理轨迹：
        {current_trajectory}
        最近3条思维链（COT）：
        {recent_cot}
        历史反思记录：
        {persistent_memory}
        预测結果：{prediction}
        实际結果：{actual}
        评分：{score}分
        预测時使用的信息：{info}

        输出格式（严格文本模板）：\n


