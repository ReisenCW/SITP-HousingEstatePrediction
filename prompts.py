# prompts.py
PROMPTS = {
    # 解析问题（区域和时间范围）
    "parse_query": """
    请从问题中提取房价预测的区域和时间范围，输出格式：
    区域：[具体区域]
    时间范围：[预测的时间段]
    例子：
    问题：2024年上半年黄浦董家渡房价走势如何
    区域：[黄浦区董家渡]
    时间范围：[2024年1月-6月]
    问题：{query}
    """,

    # 搜索相关信息
    "search_related_info": """
    请联网搜索与{region}房价相关且发生在{time_range}及其之前6个月内的相关消息(一定不能晚于{time_range}),新闻或政策，总结为利好和利空因素，注意时间越久远，相关性越低，因此时间距离较大时只需要考虑那些影响房价较大的因素。
    每条消息简明扼要，注明时间，来源和标题，用一句话说明，只输出消息列表，不要解释。
    """,

    # 预测房价趋势（带动态内容拼接逻辑）
    "predict_trend": """
    综合权衡以下提供的所有利好与利空信息，客观预测{region}在{time_range}的房价趋势及幅度。
    幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
    信息：{info}
    同时根据历史的反思记录和COT轨迹, 吸取成功失败的经验教训, 避免犯同样的错误：
    {reflection_history}
    {recent_cot}

    请严格按下面的结构化模板输出，不要省略任何小节，每一项尽量以数据或明确边界说明，避免模糊表述（如“情绪转暖”）。

    1. 政策分析：[政策名称+时间+适用范围+对目标区域的直接/间接影响，若有量化影响请给出可验证指标]
    2. 区域特性：[供应/需求结构+历史价格波动特征+流动性（近6个月成交量）——用具体数值或区间说明]
    3. 量价关系：[成交量变化（绝对/同比/环比）+成交价/挂牌价趋势+是否存在“以价换量”等特殊情况，用数据锚定]
    4. 时间边界：[信息是否在预测周期内+政策时滞评估（如3个月/6个月），若不在周期内说明延迟生效风险]
    5. 历史反思复用：[如果没有用到反思,回答无。如果引用了过往类似案例的反思结论，说明如何规避同类错误，给出参考案例的量化对比]
    6. 结论（预测结果）：[趋势+幅度，给出置信度/理由，并列出两个对冲情景及触发条件]
    房价预测结果:
    幅度 + 上升/下降/基本持平/先上升后下降等,涨/跌幅约X%左右/X%-Y%/X%以内

    输出示例：
    1. 政策分析：XXX（2024-06，适用于市级→对朝阳区二手限购有直接影响：放松限购，预计新增成交=+10%）
    2. 区域特性：近6月网签量=25500套（同比+30%），历史年化波动=±6%
    3. 量价关系：网签量↑30%，成交均价环比+0.3%，说明以价换量为主
    4. 时间边界：政策于预测周期前1月公布，预计影响滞后1-2月
    5. 历史反思复用：参考2024年X市xxx案例，xxx
    6. 结论（预测结果）：小幅上升，约1%（置信度中等）；对冲情景A: 若网签量持续↑且挂牌价↑则上行幅度可达3%；情景B: 若信贷收紧则可能回落至持平
    房价预测结果:
    小幅上升,涨幅约1%左右
    """,

    # 获取实际趋势
    "get_actual_trend": """
    请联网查询{region}在{time_range}的实际房价均价趋势及幅度。
    幅度可以是具体值或范围（如"1%-3%"、"0.5%以内"），趋势为上升/下降/持平/先上升后下降。
    输出格式例如：
    - 小幅上升,约1%左右
    - 基本持平,0.5%以内
    - 先小幅上升,1%左右,后大幅下降,约5%左右
    不添加任何额外内容
    """,

    # 成功反思
    "generate_reflection_success": """
    你是房价预测智能体的反思模块（reflect_llm）。本次预测被评分为{score}分（成功）。{history_reminder}请基于下列信息输出一份结构化且可复用的“成功反思”，重点固化有效逻辑与复用框架：
    问题：{query}
    当前推理轨迹：
    {current_trajectory}
    最近3条思维链（COT）：
    {recent_cot}
    历史反思记录：
    {persistent_memory}
    预测结果：{prediction}
    实际结果：{actual}
    评分：{score}分
    预测时使用的信息：{info}

    输出要求（严格遵守）：
    反思（成功）：\n
    1. 关键因素：用1-3条短句明确指出这次预测成功的核心依据（尽量使用数据或可验证的断言），例如"准确区分政策适用区域（外环外）与目标区域（黄浦区）"。
    2. 推理逻辑验证：列出1-3个你当时主要的假设/判断并说明是否被实际结果验证，示例："量价关系判断成立 —— 网签量↑但均价环比仅+0.3%，与以价换量判断一致"。
    3. 可复用框架：提炼可直接复用到未来预测中的方法（3点以内），格式为"规则/度量 → 触发条件 → 建议的操作"，例如"核心区预测：优先评估历史波动率与交易频次 → 若季度涨幅均<0.5%且月均成交<X则低弹性 → 下调幅度预期"。
    4. 可执行条目：给出3条可直接编码或加入数据管线的改进（字段/指标/阈值），例如新增字段"历史季度波动率_3Y"并写出阈值说明。
    5. 示例与量化证据：引用本次案例中的明确数据点（时间/量/价）作为示例，便于后续审计与教学。

    输出格式（严格文本模板）：
    反思（成功）：\n1. 关键因素：...\n2. 推理逻辑验证：...\n3. 可复用框架：...\n4. 可执行条目：...\n5. 示例与量化证据：...
    """,

    # 失败反思
    "generate_reflection_failure": """
    你是房价预测智能体的反思模块（reflect_llm）。本次预测被评分为{score}分（失败/偏差）。{history_reminder}请基于下列信息输出一份结构化的反思，重点指出错误、根因并给出可执行改进建议：
    问题：{query}
    当前推理轨迹：
    {current_trajectory}
    最近3条思维链（COT）：
    {recent_cot}
    历史反思记录：
    {persistent_memory}
    预测结果：{prediction}
    实际结果：{actual}
    评分：{score}分
    预测时使用的信息：{info}

    输出格式（严格文本模板）：\n
    反思（失败）：\n1. 错误分析：简要列出1-3处关键错误或漏判\n2. 失败原因：说明导致偏差的核心原因（数据/模型/逻辑/时序）\n3. 改进策略：提出3条可操作改进（具体到字段/阈值/方法）\n
    要求：建议应可直接用于未来预测流程和数据接入。
    """,

    # LLM评分规则
     "evaluator_llm_score_rule": """
     【评分规则】
     本规则用于把预测结果与实际结果文本打分，返回单个整数分数（0-100），或 -1 表示无法评分。

     概念说明：预测或实际可能是单阶段（例如“上升,1%-2%”）或多阶段（例如“先持平后小幅上升,幅度0.5%-1.5%”）。当出现多阶段预测时，本规则要求对每个阶段分别评分，然后取各阶段得分的算术平均作为最终分数。

     评分流程（严格执行）：
     1) 抽取阶段：如果预测文本包含“先...后...”或以逗号/分号分隔的多个阶段，请将其拆成若干按顺序的阶段；若预测为单阶段则只有一个阶段。
     2) 解析每个阶段：对每个阶段分别提取趋势类别（“上升”“下降”“持平”等）和幅度描述（可能是"X%","X%-Y%","约X%","0.5%以内","小幅"等）。
         - 文本映射：当幅度为描述性词语时按经验映射："小幅"→0.5%-2%（取中点1.25%为代表值），"显著"→>3%（取3.0%作为下限代表值，仅在无更精确信息时使用），"持平"可解释为代表值0.5%。
     3) 将每个幅度区间规范化为代表值（取区间中点或合理保守估计）：例如"1%-2%"→1.5%，"0.5%以内"→0.5%，"约1%"→1.0%。
     4) 单阶段得分（per-phase score）计算：
         - 若预测阶段与实际阶段的趋势方向明确相反（例如预测为“上升”而实际为“下降”）→ 该阶段得分=0。
         - 否则计算两者代表值之差 d = |pred_mag - actual_mag|（单位：百分比点）。
            per_phase_score = max(0, round(100 - 20 * d)).
            （说明：每差1个百分点扣20分；差0 → 100分；差5个百分点或更大 → 0分）
         - 若存在明显方向性矛盾（例如预测“持平”但实际为“上升”且实际代表值>3%），在本阶段分数上额外扣10分（下限0）。
     5) 多阶段组合：
         - 如果预测有多阶段而实际为单阶段（常见场景），则把单阶段实际值与每个预测阶段分别比较，得到每个阶段分数，然后取这些阶段分数的算术平均（round为整数）作为最终分数。
         - 如果两边均为多阶段，按顺序一一对应比较（长度不同时，多出阶段分别与最后一个实际阶段比较），再取平均。
     6) 特殊情况：若实际为“未知”或无法解析代表值→ 返回 -1（无法评分）。

     输出要求：严格输出单个整数（例如"95"），不要输出其他文字（仅可在需要的审计情况下返回一行注释，但首要要求是单个整数）。

     示例（与你的问题对应）：
     预测：先持平后小幅上升,幅度0.5%-1.5% → 分为两个阶段：阶段A=持平(代表值0.5%)，阶段B=小幅上升(代表值1.0%)
     实际：基本持平,0.5%以内 → 单阶段 持平(代表值0.5%)
     阶段A对比实际：d=0 → scoreA=100
     阶段B对比实际：d=|1.0-0.5|=0.5 → scoreB=round(100 - 20*0.5)=90
     最终分数 = round((100+90)/2) = 95 → 输出：95
     """,

    # llm 评分
    "evaluator_score": """
        请根据以下评分规则，对预测结果与实际结果进行评分，满分100分，输出数字分数。
        {LLM_SCORE_RULE}
        预测趋势：{prediction}
        实际趋势：{actual_trend}
        只输出分数数字，不要解释。
    """
}


